<!DOCTYPE html>
<meta charset="utf-8">
<html>

<head>
    <title>Clash Synergy Network</title>
    <style>
        line {
            stroke: #ccc;
            stroke-width: 1.5px;
        }
    </style>
</head>

<body>
    <!-- <script src="https://d3js.org/d3.v7.min.js"></script> -->
    <script src="https://d3js.org/d3.v3.min.js"></script>

    <!-- Custom JS -->
    <script>

        // force layout
        const width = 1400,
            height = 700;

        // const color = d3.scale.category20();

        const svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

        const force = d3.layout.force()
            .gravity(0.05)
            .distance(200)
            .charge(-400)
            .size([width, height]);

        // graph logic
        d3.json("graph.json", async (error, graph) => {
            if (error) throw error;

            // get a maping of card-URL for vertex icons
            const cardsResp = await fetch("cards.json");
            const cardsJSON = await cardsResp.json();
            const cardsArray = cardsJSON.items.map(card => {
                let name = card.name;
                name = name.replaceAll(" ", "_");
                name = name.replaceAll("-", "_");
                const obj = {};
                obj[name] = card.iconUrls.medium;
                return obj;
            });
            const allCards = cardsArray.reduce(((r, c) => Object.assign(r, c)), {});

            // graph data
            const vertices = d3.keys(graph),
                nodes = vertices.map(d => {
                    return { name: d, url: allCards[d], group: 1 }
                }),
                links = d3.merge(vertices.map(source => {
                    return graph[source].map(target => {
                        return { source: vertices.indexOf(source), target: vertices.indexOf(target) };
                    });
                }));

            force
                .nodes(nodes)
                .links(links)
                .start();

            // create DOM elements
            const link = svg.selectAll(".link")
                .data(links)
                .enter().append("line");

            const node = svg.selectAll(".node")
                .data(nodes)
                .enter().append("g")
                .attr("class", "node")
                .call(force.drag);

            node.append("image")
                .attr("xlink:href", d => d.url)
                .attr("x", -8)
                .attr("y", -8)
                .attr("width", 28)
                .attr("height", 28);

            // node.append("text")
            //     .attr("dx", 12)
            //     .attr("dy", ".35em")
            //     .text(d => d.name);

            // interaction logic
            force.on("tick", () => {
                link.attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node.attr("transform", d => "translate(" + d.x + "," + d.y + ")");

            });
        });

    </script>
</body>

</html>